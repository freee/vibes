import { Story, Canvas } from '@storybook/addon-docs/blocks';

# フォーム

vibes では3種類のフォームの組み方を提供しています

- 縦フォーム
- 横フォーム
- リストフォーム

いずれの場合にも、**アクセシビリティの確保** と **エラーの表示方法** に注意を払ってください。

## 縦フォーム

`DescriptionList` を使用して項目を縦方向に並べるフォーム形式です。

- 入力欄の説明を丁寧に表記したり、グルーピングの表現をしたりしやすい形式です
- 利用頻度が低く、ユーザーの学習効果を期待しづらい場所での使用に適しています
- 行にフィールドが1つしかない場合には `DescriptionList` の `title` = 左側カラムに `<label>` 要素を、
  複数ある場合にはそれぞれのフィールドにラベルを配置し（ `value` = 右側カラム内に横フォームを配置するのを推奨 ）、
  必ずフィールドとラベルが紐付けられている状態にしてください
  - aXe または Lighthouse で紐付けが行われているか確認することを推奨します

<Canvas>
  <Story id="examples-forms--vertical-form" />
</Canvas>

## 横フォーム

`FormControl` と `FormControlGroup` を使用して項目を横方向に並べるフォーム形式です

- たくさんの入力欄をコンパクトに配置する形式です。
- 利用頻度が高く、ユーザーの学習効果を期待でき、描画領域を節約したい場所に適しています
- `FormControl` 内にフィールドが1つしかない場合には、`FormControl` の `fieldId` propにフィールドの `id` を渡し、
  必ずフィールドとラベルが紐付けられている状態にしてください
  - `FormControl` は `<fieldset>` 要素になっているため、ラジオボタンが配置される場合や複数のフィールドが配置される場合は `fieldId` による紐付けは不要です
  - aXe または Lighthouse で紐付けが行われているか確認することを推奨します

<Canvas>
  <Story id="examples-forms--horizontal-form" />
</Canvas>

## リストフォーム

オブジェクトが複数持つ子オブジェクトをシングル画面で一括で編集する際などに使用するフォーム形式です。

- たくさんの小さなオブジェクトを一度に編集する場所で使用します
  - 子オブジェクトの編集項目が多い場合は、別画面にしたり、`TaskDialog` に切り出すなどを検討してください
  - 一度にたくさん編集することが想定されない場合も、別画面にしたり、`TaskDialog` に切り出すなどを検討してください
- ひとつの項目名に対してたくさんのフィールドが紐付くため、`<label>` 要素は使用しません
  - `aria-label` にて、 `1行目の日付` のように、何行目を操作しているのかわかるラベルを指定してください
  - aXe または Lighthouse で紐付けが行われているか確認することを推奨します

<Canvas>
  <Story id="examples-forms--list-form" />
</Canvas>


## フォーム送信のインタラクション

ボタンのラベルが「保存」「作成」「登録」などであっても、ここでは「送信」として扱います。

- 送信中は送信ボタンやその他のアクションボタンを `disabled` にし、マウス操作だけでなくキーボード操作でもアクションできないようにしてください
  - `Loading` 等で覆われる場合でも、必ず `disabled` にしてください
- 送信が成功した場合はページ遷移やモーダルの開閉、フォーカスの移動、`FloatingMessageBlock` などによってユーザーに送信が完了したフィードバックをしてください
- 送信が失敗した場合は `FloatingMessageBlock` を `error` で表示し、ユーザーに送信が失敗したフィードバックをしてください

<Canvas>
  <Story id="examples-forms--submit-success-interaction" />
</Canvas>


### フォームのエラー表示

- 送信の失敗時には、 `FloatingMessageBlock` でエラーの存在をユーザーに伝え（スクリーンメッセージ）、`Message` で個別のエラーの詳細をユーザーに伝えてください（インラインメッセージ）
  - `FloatingMessageBlock` を使用すると、 `aria-live` 属性によりスクリーンリーダー等の支援技術にエラーが起きていることを伝えることができます
- 複数のセクションのある長大なフォームの場合、エラーが発生しているセクションに `MessageBlock` を配置してください（セクションメッセージ）
- 多くの場合、サーバー側でエラーの検証が必須となるため、送信ボタンを押すまで入力内容がエラーとなるかどうかを予測することができません。
  そのため、必ずしも「クライアント側でエラー検証を行い、エラーが無くなるまで送信ボタンを押せなくする」必要は **ありません**
  - クライアント側で検証できなかったエラーがサーバー側で発見された場合、ユーザーは両方のエラーを修正する2度手間を強いられてしまいます
  - もしクライアント側でエラーを修正するまで送信できなくする場合は、送信ボタンの周囲にエラーの修正が必要であることがわかるよう、メッセージを記載してください
- もし入力フィールドごとのエラーメッセージを記載できない場合は、フォーム上部に `MessageBlock` でまとめて記載しても構いません
  - その場合でも、同時に `FloatingMessageBlock` を表示し、「エラーが起きていること」に気付けるようにしてください。
  - 可能なかぎり、フィールドごとにエラーメッセージを記載するようにしてください

<Canvas>
  <Story id="examples-forms--submit-error-interaction" />
</Canvas>

#### ダイアログ内のエラー表示

- `TaskDialog` 内にフォームを配置している場合でも、 `FloatingMessageBlock` を使用してスクリーンメッセージを表示してください

<Canvas>
  <Story id="examples-forms--error-on-task-dialog" />
</Canvas>


### フロントエンドでのバリデーション

- フォームのバリデーション（入力内容の検証）はサーバーサイドで必ず行う必要があるため、フロントエンドで行う必要はありません
  - フロントエンドで入力内容のバリデーションを行う場合、ユーザーが正しく入力するための補助と位置付けてください
- 入力中のユーザーにストレスを与えないよう、フロントエンドでのバリデーションはエラーとは別の形で表現し、送信ボタンを押すなどの形でユーザーが入力を終えた意思が明らかになってからエラーとして表示してください
  - 通常、サーバーサイドでも同じようなバリデーションを行うことになるため、エラーとしての表示はそちらの結果を表示するかたちに寄せてしまうのが良いでしょう
- `Balloon` や `Note` コンポーネントによる注釈は、スクリーンリーダーや拡大表示を使用しているユーザーは気付かない可能性があることに注意してください
  - `氏名（カタカナ）` のような入力形式がわかりやすい項目名にしたり、「ハイフンなしで 1410031 のように入力してください」という注釈文を表示したりして、入力開始前に正しい記入方法がわかるようにしてください
  - `DigitsInput` のように全角半角などの文字種別を自動的に修正したり、郵便番号のハイフン有り・無しどちらも許容したりするなど、入力形式のエラーが起こりにくい工夫をすることを検討してください

<Canvas>
  <Story id="examples-forms--frontend-validation" />
</Canvas>

#### バリデーションエラー時の送信ボタン無効化

- サーバーサイドでバリデーションを行う前提があるため、フロントエンドでのバリデーションが通るまで送信ボタンを無効化したりする必要はありません
- もし無効化する場合はなぜ送信ボタンが無効であるのか、ユーザーが理解できるようにしてください
  - ボタンの周囲に注釈テキストを表示したり、バルーンでメッセージを表示したりしてください
  - `aria-describedby` によって、それらのメッセージを無効化されたボタンに紐付けてください
- どの入力項目が原因で送信できないのかがわかりにくくなるため、入力項目が多い入力フォームや、必須項目とそうでない項目が順番的に混在しているフォームでの使用は避けてください
  - 必須項目とそうでない項目が存在する場合、必須項目を先に、そうでない項目を後に並べるようにしてください
- バリデーション結果をエラーとして表示する場合にはBlur時以降に表示するようにするなど、入力中・入力前のユーザーへのストレスに配慮してください
　

<Canvas>
  <Story id="examples-forms--disable-button-if-invalid" />
</Canvas>

## フォーム作成の注意点

- ラベルとフィールドの紐付けを必ず行ってください
  - freeeアクセシビリティー・ガイドライン: [フォーム・コントロールのラベル付けの必要性](https://a11y-guidelines.freee.co.jp/explanations/form-labeling.html)
  - aXe または Lighthouse で紐付けが行われているか確認することを推奨します
- ユーザーが自分自身の情報を入力するフォームでは、 `autoComplete` 属性を使用して自動補完が効く状態にしてください
  - ただし、自分自身 **以外** の情報を入力するフォームでは、 `autoComplete` を `off` にしてください
  - `autoComplete` 属性に何を指定するべきかは、MDN: [HTML の autocomplete 属性](https://developer.mozilla.org/ja/docs/Web/HTML/Attributes/autocomplete) を参照してください
- 安易な `placeholder` の使用は推奨しません
  - `placeholder` の文字列は通常のテキストよりもコントラストの低い色の組み合わせになっているため、可読性が下がります
    - コントラストの高い色を使用すると、入力済み文字列との区別が付かなくなるおそれがあります
  - 記入をし始めてしまうと `placeholder` の内容が確認できなくなります。可読性の問題もあるので記入に必要な情報を `placeholder` にするべきではありません
